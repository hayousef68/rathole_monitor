<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>مانیتور تانل‌های Rathole</title>
  <style>
    :root { --bg:#f5f6f8; --card:#fff; --muted:#6c757d; --ok:#28a745; --err:#dc3545; --primary:#007bff; }
    body{margin:0;background:var(--bg);font-family:IRANSans,Segoe UI,Arial,sans-serif}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .title{font-weight:700;color:#222;font-size:20px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:12px 0}
    .card{background:var(--card);border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,.06);padding:16px}
    .muted{color:var(--muted);font-size:12px}
    .stat{font-size:28px;font-weight:700}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{border:0;border-radius:6px;padding:8px 12px;cursor:pointer}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-ok{background:var(--ok);color:#fff}
    .btn-err{background:var(--err);color:#fff}
    .btn-outline{background:transparent;border:1px solid #ddd}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
    .badge-ok{background:#e9f8ee;color:var(--ok);border:1px solid #caefd5}
    .badge-err{background:#fdecec;color:var(--err);border:1px solid #f8c7c7}
    .list{display:grid;gap:10px}
    .item{display:flex;justify-content:space-between;align-items:center;gap:16px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .small{font-size:12px}
    .grow{flex:1}
    .sep{height:1px;background:#eee;margin:8px 0}
    .logs{white-space:pre-wrap;background:#0e1116;color:#c9d1d9;border-radius:8px;padding:12px;font-family:ui-monospace,Consolas,monospace;font-size:12px;max-height:300px;overflow:auto}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">🔧 مانیتور تانل‌های Rathole</div>
      <div class="row">
        <button id="btn-refresh" class="btn btn-outline">بروزرسانی</button>
        <button id="btn-monitor-toggle" class="btn btn-primary">...</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="muted">کل تانل‌ها</div>
        <div id="stat-total" class="stat">0</div>
      </div>
      <div class="card">
        <div class="muted">تانل‌های فعال</div>
        <div id="stat-active" class="stat">0</div>
      </div>
      <div class="card">
        <div class="muted">مدت اجرای مانیتور</div>
        <div id="stat-uptime" class="stat mono">—</div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div class="muted">فهرست تانل‌ها</div>
        <div class="small muted">هر مورد را می‌توانید ریستارت کنید</div>
      </div>
      <div id="list" class="list" style="margin-top:10px;"></div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="row" style="justify-content:space-between;">
        <div class="muted">لاگ‌های سرویس انتخاب‌شده</div>
        <div class="row">
          <input id="log-name" placeholder="نام سرویس (مثلاً rathole-iran-8080)" style="padding:8px;border-radius:6px;border:1px solid #ddd;width:260px;">
          <button id="btn-load-logs" class="btn btn-outline">نمایش لاگ</button>
        </div>
      </div>
      <div id="logs" class="logs" style="margin-top:10px;">—</div>
    </div>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);
    const listEl = $('#list');
    const statTotal = $('#stat-total');
    const statActive = $('#stat-active');
    const statUptime = $('#stat-uptime');
    const btnRefresh = $('#btn-refresh');
    const btnMonitorToggle = $('#btn-monitor-toggle');
    const logsBox = $('#logs');
    const logName = $('#log-name');
    const btnLoadLogs = $('#btn-load-logs');

    let monitoringActive = false;
    let lastData = null;

    async function api(path, opts={}) {
      const res = await fetch(path, { headers: {'Content-Type':'application/json'}, ...opts });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    function tunnelItem(t) {
      const active = (t.status||'').toLowerCase()==='active';
      const badge = `<span class="badge ${active?'badge-ok':'badge-err'}">${active?'فعال':'غیرفعال'}</span>`;
      return `
        <div class="item">
          <div class="grow">
            <div class="row" style="gap:10px;align-items:baseline;">
              <div class="mono">${t.name}</div>
              ${badge}
              <div class="small muted">نوع: ${t.type||'-'}</div>
              <div class="small muted">ریستارت: ${t.restart_count ?? 0}</div>
              ${t.last_restart ? `<div class="small muted">آخرین ریستارت: ${t.last_restart}</div>` : ''}
            </div>
          </div>
          <div class="row">
            <button class="btn btn-err" onclick="restartTunnel('${t.name.replace(/'/g,"\\'")}')">ریستارت</button>
            <button class="btn btn-outline small" onclick="loadLogs('${t.name.replace(/'/g,"\\'")}')">لاگ</button>
          </div>
        </div>
        <div class="sep"></div>
      `;
    }

    async function loadStatus() {
      try {
        const data = await api('/api/status');
        lastData = data;
        monitoringActive = !!data.monitoring_active;
        btnMonitorToggle.textContent = monitoringActive ? 'توقف مانیتور' : 'شروع مانیتور';
        statUptime.textContent = data.uptime || '—';
        const tunnels = data.tunnels || [];
        statTotal.textContent = tunnels.length;
        statActive.textContent = tunnels.filter(x => (x.status||'').toLowerCase()==='active').length;
        listEl.innerHTML = tunnels.map(tunnelItem).join('') || '<div class="muted small">تانلی یافت نشد</div>';
      } catch (e) {
        console.error(e);
        listEl.innerHTML = `<div class="muted small">خطا در دریافت وضعیت</div>`;
      }
    }

    async function restartTunnel(name) {
      try {
        const res = await api('/api/restart', { method:'POST', body: JSON.stringify({name})});
        if (res.ok) {
          await loadStatus();
          alert(`سرویس ${name} ${res.active ? 'بالا آمد' : 'هنوز غیرفعال است'}`);
        } else {
          alert(res.error || 'خطا در ریستارت');
        }
      } catch (e) {
        alert('خطا در ریستارت');
      }
    }

    async function monitorToggle() {
      try {
        const path = monitoringActive ? '/api/monitor/stop' : '/api/monitor/start';
        const res = await api(path, { method:'POST' });
        monitoringActive = !!res.active;
        btnMonitorToggle.textContent = monitoringActive ? 'توقف مانیتور' : 'شروع مانیتور';
        setTimeout(loadStatus, 800);
      } catch (e) {
        alert('خطا در تغییر وضعیت مانیتور');
      }
    }

    async function loadLogs(name) {
      if (name) logName.value = name;
      const svc = logName.value.trim();
      if (!svc) { alert('نام سرویس را وارد کنید'); return; }
      try {
        const res = await api(`/api/logs?name=${encodeURIComponent(svc)}&n=100`);
        logsBox.textContent = res.logs || 'لاگی یافت نشد';
      } catch (e) {
        logsBox.textContent = 'خطا در دریافت لاگ‌ها';
      }
    }

    btnRefresh.addEventListener('click', loadStatus);
    btnMonitorToggle.addEventListener('click', monitorToggle);
    btnLoadLogs.addEventListener('click', () => loadLogs(logName.value));

    // بارگذاری اولیه و بروزرسانی دوره‌ای
    loadStatus();
    setInterval(loadStatus, 5000);
  </script>
</body>
</html>
```
